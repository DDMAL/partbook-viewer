<!doctype html>
    <html lang="en">
        <head>
            <meta charset="utf-8" />
            <title>Diva.JS Partbook Viewer</title>
            <link rel="stylesheet" href="diva.js/build/css/diva.min.css" />
            <link rel="stylesheet" href="partbookViewer.css" />
            <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <![endif]-->
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
            <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
            <!--<script src="diva.js/build/js/diva.min.js" type="text/javascript"></script>-->
            <script src="diva.js/build/js/diva.js" type="text/javascript"></script>
            <script src="diva.js/build/js/utils.js" type="text/javascript"></script>
            <script src="diva.js/build/js/plugins/highlight.js" type="text/javascript"></script>


            <script src="partbookViewer.js" type="text/javascript"></script>

            <script type="text/javascript">
                //wrapper for a diva viewer with page functionality and synchronicity
                function Part(div, num)
                {
                    this.partbookNum = num;
                    this.divaElement = $(div);

                    this.divaElement.diva(generateDivaOptions(num));

                    //changes currently visible page
                    this.changePage = function(compositionID)
                    {
                        //unhook the diva event so it doesn't get called again
                        diva.Events.unsubscribe(divaChangeHandle);
                        //get the initial page index for the composition ID, add the amount of pages that Diva/DIAMM add
                        var pageIndex = partbookData[this.partbookNum][compositionID][0] + pageOffsets[this.partbookNum];
                        //change to the correct page
                        this.divaElement.data('diva').gotoPageByIndex(pageIndex);
                        //turn the diva event back on
                        divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                    };

                    //gets the composition active at a given page number
                    this.getComposition = function(pageNum)
                    {
                        //gets the diva index in, subtracts the diva/DIAMM offset
                        var adaptedPageNum = pageNum - pageOffsets[this.partbookNum];
                        //iterates through partbook data
                        for(curComposition in partbookData[this.partbookNum])
                        {
                            //return the first composition on that page
                            if(partbookData[this.partbookNum][curComposition].indexOf(adaptedPageNum) > -1)
                            {
                                return curComposition;
                            }
                        }
                        return false;
                    };
                }

                //listener for when diva changes pages
                function divaChangeListener(pageIndex, filename)
                {
                    //as there's one central diva events listener, get the partbook ID from the filename of the image
                    var partbookNum = filename.match(/\d{3}/g);
                    //determine what composition is on this page
                    var newComposition = parts[partbookNum].getComposition(pageIndex);
                    //if it changed
                    if(newComposition && (currentComposition != newComposition))
                    {
                        currentComposition = newComposition;

                        //don't change pages/titles again
                        selectSkip = true;
                        $("#piece-" + currentComposition).prop('selected', 'selected');
                        selectSkip = false;

                        //go through every part that is NOT the one that just changed and change pages
                        for(curKey in parts)
                        {
                            if(curKey != partbookNum)
                            {
                                parts[curKey].changePage(currentComposition);
                            }
                        }
                    }
                }

                //listener for simultaneous scrolling; not anonymous so that we can unbind
                function simScrollListener()
                {
                    var scrolledPart = $(this).parent().attr('id').match(/\d{3}/g)[0];
                    var scrollDiffY = $(this).scrollTop() - oldScrollTopYList[scrolledPart];
                    var scrollDiffX = $(this).scrollLeft() - oldScrollTopXList[scrolledPart];
                    for(curPart in parts)
                    {
                        if(curPart != scrolledPart)
                        {
                            $("#diva-wrapper-" + curPart + " > .diva-outer").scrollTop($("#diva-wrapper-" + curPart + " > .diva-outer").scrollTop() + scrollDiffY);
                            $("#diva-wrapper-" + curPart + " > .diva-outer").scrollLeft($("#diva-wrapper-" + curPart + " > .diva-outer").scrollLeft() + scrollDiffX);    
                        }
                    }
                    updateScrollArchive();
                }

                //could be combined into Part
                function generateDivaOptions(num)
                {
                    return {
                        adaptivePadding: 0,
                        enableAutoHeight: false,
                        enableAutoTitle: false,
                        enableAutoWidth: false,   
                        enableCanvas: false,        
                        enableDownload: false,
                        enableFullscreen: false,
                        enableGridIcon: false,
                        enableLinkIcon: false,
                        fixedHeightGrid: false,
                        iipServerURL: "http://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
                        objectData: "json/partbook" + num + ".json",
                        imageDir: "/srv/images/dow_partbooks/" + num,
                        viewerWidthPadding: 0,
                        viewerHeightPadding: 0,
                        zoomLevel: 2
                    };
                }

                function updateScrollArchive()
                {
                    for(curPart in parts)
                    {
                        oldScrollTopYList[curPart] = $("#diva-wrapper-" + curPart + " > .diva-outer").scrollTop();
                        oldScrollTopXList[curPart] = $("#diva-wrapper-" + curPart + " > .diva-outer").scrollLeft();
                    }
                }

                var partbookData = {};
                var parts = {};
                var pageOffsets = { //as each book seems to be slightly off from its Diva indexes because of the notes in the beginning. No way to not hardcode this.
                    '984': 4,
                    '985': 2,
                    '986': 2,
                    '987': 2,
                    '988': 2
                };
                var currentComposition;
                var divaChangeHandle;
                var selectSkip = true;
                var simultaneousScrolling = false;
                var oldScrollTopYList = {};
                var oldScrollTopXList = {};

                $(document).ready(function() 
                {                
                    //when the toggle scrolling button is called
                    $("#toggleScrolling").on('click', function(){
                        if(simultaneousScrolling)
                        {
                            //turn page change listener back on
                            divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                            $(".diva-outer").unbind('scroll', simScrollListener);
                            simultaneousScrolling = false;
                            $("#toggleScrolling").text("Turn on simultaneous scrolling");
                        }
                        else
                        {
                            updateScrollArchive();
                            //unhook change listener as it'll keep changing when we change pages, which we DON'T want to happen if simultaneous scrolling is on
                            diva.Events.unsubscribe(divaChangeHandle);
                            var oldScrollTopY = 0;
                            var oldScrollTopX = 0;
                            $(".diva-outer").on('scroll', simScrollListener);
                            simultaneousScrolling = true;
                            $("#toggleScrolling").text("Turn off simultaneous scrolling");
                        }
                    });

                    //control panel is draggable and minimizable
                    $(".control-panel").draggable({});
                    $("#toggleCPanel").on('click', function(){
                        $("#cPanelContent").toggle();
                        $("#toggleCPanel").text(($("#cPanelContent").css('display') == "none" ? "Maximize" : "Minimize"));
                    });

                    //get the partbook data file
                    $.ajax(
                    {
                        url: 'partbooks.json',
                        cache: true,
                        dataType: 'json',
                        success: function (data, status, jqxhr)
                        {
                            //parsing
                            pieces = data['pieces'];
                            partbookData = data['csvData'];
                            pieces2 = data['debugPieces'];

                            //subscribe
                            divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                            
                            //fill the select
                            for(curIndex in pieces)
                            {
                                var curID = pieces[curIndex][0];
                                var curTitle = pieces[curIndex][1];
                                $("#compositionSelect").append("<option id='piece-" + curID + "' pieceid='" + curID + "'>" + curTitle + "</option>");
                            }

                            //on-change listener to jump to pieces
                            $("#compositionSelect").on('change', function(e){
                                if(!selectSkip)
                                {
                                    var newPiece = $(e.target).find(":selected");
                                    var newPieceID = newPiece.attr('pieceid');

                                    for(curPartIndex in parts)
                                    {
                                        parts[curPartIndex].changePage(newPieceID);
                                    }
                                }
                            });

                            //create parts
                            for(curKey in partbookData)
                            {
                                $("body").append("<div id='diva-wrapper-" + curKey + "' class='diva-wrapper'></div>");
                                parts[curKey] = (new Part('#diva-wrapper-' + curKey, curKey));
                            }

                            var loadedCount = 0;
                            diva.Events.subscribe('ViewerDidLoad', function()
                            {
                                loadedCount += 1;
                                //once all five divas have loaded
                                if(loadedCount == $('.diva-wrapper').length)
                                {
                                    //add minimize buttons in place of zoom labels
                                    $('.diva-buttons-label').html("<button class='minimizer'>Minimize</button>");
                                    $('.minimizer').on('click', function(e)
                                    {
                                        //when minimize is clicked
                                        var wrapperParent = $(e.target).closest('.diva-wrapper');
                                        wrapperParent.hide();
                                        //get the id of the partbook
                                        var bookTitle = wrapperParent.attr('id').match(/\d{3}/g);
                                        //add a way to maximize it to the control panel
                                        $("#minimized-objects").append("<span id='maximize-" + bookTitle + "' class='maximize-wrapper'>" + bookTitle + "<button class='maximizer'>Maximize</button></span>");

                                        //when that is clicked
                                        $('.maximizer').on('click', function(e)
                                        {
                                            //get the ID and maximize
                                            var maximizeParent = $(e.target).closest('.maximize-wrapper');
                                            var bookTitle = maximizeParent.attr('id').match(/\d{3}/g);
                                            maximizeParent.remove();
                                            $("#diva-wrapper-" + bookTitle).show();
                                        });
                                    });
                                    
                                    //make draggable
                                    $('.diva-wrapper').draggable({
                                        start: function(e, ui)
                                        {
                                            $('.diva-wrapper').css('z-index', 2);
                                            ui.helper.css('z-index', 3);
                                        }
                                    });
                                }
                            });
                            selectSkip = false;
                        }
                    });
                    
                });
            </script>
        </head>
        <body>
            <div class="control-panel">
                <div style="width:100%;height:auto;">
                    <span style="float:left;margin-right:50px;">Control Panel</span>
                    <button style="float:right;" id="toggleCPanel">Minimize</button>
                </div><br>
                <div id="cPanelContent">
                    <button id='toggleScrolling'>Turn on simultaneous scrolling</button><br>
                    Jump to piece: <select style="margin-left:10px" id="compositionSelect"><option>---</option></select>
                    <div id="minimized-objects"></div>
                </div>
            </div>
        </body>
    </html>
