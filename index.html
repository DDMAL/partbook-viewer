<!doctype html>
    <html lang="en">
        <head>
            <meta charset="utf-8" />
            <title>Diva.JS Partbook Viewer</title>
            <link rel="stylesheet" href="diva.js/build/css/diva.min.css" />
            <link rel="stylesheet" href="partbookViewer.css" />
            <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <![endif]-->
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
            <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
            <!--<script src="diva.js/build/js/diva.min.js" type="text/javascript"></script>-->
            <script src="diva.js/build/js/diva.js" type="text/javascript"></script>
            <script src="diva.js/build/js/utils.js" type="text/javascript"></script>
            <script src="diva.js/build/js/plugins/highlight.js" type="text/javascript"></script>


            <script src="partbookViewer.js" type="text/javascript"></script>

            <script type="text/javascript">
                function Part(div, num)
                {
                    this.partbookNum = num;
                    this.divaElement = $(div);

                    this.divaElement.diva(generateDivaOptions(num));

                    this.changePage = function(compositionID)
                    {
                        var pageIndex = partbookData[this.partbookNum].indexOf(compositionID);
                        this.divaElement.data('diva').gotoPageByIndex(pageIndex);
                    };

                    this.getComposition = function(pageNum)
                    {
                        return partbookData[this.partbookNum][pageNum];
                    };
                }

                function divaChangeListener(pageIndex, filename)
                {
                    diva.Events.unsubscribe(divaChangeHandle);
                    var partbookNum = filename.match(/\d{3}/g);
                    if(currentComposition != parts[partbookNum].getComposition(pageIndex))
                    {
                        currentComposition = parts[partbookNum].getComposition(pageIndex);
                        for(curKey in partbookData)
                        {
                            if(curKey != partbookNum)
                            {
                                parts[curKey].changePage(currentComposition);
                            }
                        }
                    }
                    divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                }

                function generateDivaOptions(num)
                {
                    return {
                        adaptivePadding: 0,
                        enableAutoHeight: false,
                        enableAutoTitle: false,
                        enableAutoWidth: false,   
                        enableCanvas: false,        
                        enableDownload: false,
                        enableFullscreen: false,
                        enableGridIcon: false,
                        enableLinkIcon: false,
                        fixedHeightGrid: false,
                        iipServerURL: "http://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
                        objectData: "json/partbook" + num + ".json",
                        imageDir: "/srv/images/dow_partbooks/" + num,
                        viewerWidthPadding: 0,
                        viewerHeightPadding: 0,
                        zoomLevel: 2
                    };
                }
                var partbookData = {};
                var parts = {};
                var currentComposition;
                var divaChangeHandle;
                $(document).ready(function() 
                {
                    $(".control-panel").draggable({});
                    $("#toggleCPanel").on('click', function(){
                        $("#cPanelContent").toggle();
                        $("#toggleCPanel").text(($("#cPanelContent").css('display') == "none" ? "Maximize" : "Minimize"));
                    });
                    $.ajax(
                    {
                        url: 'partbooks.json',
                        cache: true,
                        dataType: 'json',
                        success: function (data, status, jqxhr)
                        {
                            partbookData = data;

                            for(curKey in partbookData)
                            {
                                $("body").append("<div id='diva-wrapper-" + curKey + "' class='diva-wrapper'></div>");
                                parts[curKey] = (new Part('#diva-wrapper-' + curKey, curKey));
                            }

                            var loadedCount = 0;
                            diva.Events.subscribe('ViewerDidLoad', function()
                            {
                                loadedCount += 1;
                                //once all five divas have loaded
                                if(loadedCount == $('.diva-wrapper').length)
                                {
                                    $('.diva-buttons-label').html("<button class='minimizer'>Minimize</button>");
                                    $('.minimizer').on('click', function(e)
                                    {
                                        var wrapperParent = $(e.target).closest('.diva-wrapper');
                                        wrapperParent.hide();
                                        var bookTitle = wrapperParent.attr('id').match(/\d{3}/g);
                                        $("#minimized-objects").append("<span id='maximize-" + bookTitle + "' class='maximize-wrapper'>" + bookTitle + "<button class='maximizer'>Maximize</button></span>");
                                        $('.maximizer').on('click', function(e)
                                        {
                                            var maximizeParent = $(e.target).closest('.maximize-wrapper');
                                            var bookTitle = maximizeParent.attr('id').match(/\d{3}/g);
                                            maximizeParent.remove();
                                            $("#diva-wrapper-" + bookTitle).show();
                                        });
                                    });

                                    $('.diva-wrapper').draggable({
                                        start: function(e, ui)
                                        {
                                            $('.diva-wrapper').css('z-index', 2);
                                            ui.helper.css('z-index', 3);
                                        }
                                    });
                                }
                            });
                            divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                        }
                    });
                    
                });
            </script>
        </head>
        <body>
            <div class="control-panel">
                <div style="width:100%;height:auto;">
                    <span style="float:left;margin-right:50px;">Control Panel</span>
                    <button style="float:right;" id="toggleCPanel">Minimize</button>
                </div><br>
                <div id="cPanelContent">
                    <div id="minimized-objects"></div>
                </div>
            </div>
        </body>
    </html>
