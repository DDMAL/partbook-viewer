<!doctype html>
    <html lang="en">
        <head>
            <meta charset="utf-8" />
            <title>Diva.js Demo Page</title>
            <link rel="stylesheet" href="diva.js/build/css/diva.min.css" />
            <link rel="stylesheet" href="partbookViewer.css" />
            <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <![endif]-->
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
            <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
            <script src="diva.js/build/js/diva.min.js" type="text/javascript"></script>
            <script src="partbookViewer.js" type="text/javascript"></script>

            <script type="text/javascript">
                function Part(div, num)
                {
                    this.partbookNum = num;
                    this.divaElement = $(div);

                    this.divaElement.diva(generateDivaOptions(num));

                    this.changePage = function(compositionID)
                    {
                        var pageIndex = partbookData[this.partbookNum].indexOf(compositionID);
                        this.divaElement.data('diva').gotoPageByIndex(pageIndex);
                    };

                    this.getComposition = function(pageNum)
                    {
                        return partbookData[this.partbookNum][pageNum];
                    };
                }

                var divaChangeListener = function(pageIndex, filename)
                {
                    diva.Events.unsubscribe(divaChangeHandle);
                    var partbookNum = filename.match(/\d{3}/g);
                    if(currentComposition != parts[partbookNum].getComposition(pageIndex))
                    {
                        currentComposition = parts[partbookNum].getComposition(pageIndex);
                        for(curKey in partbookData)
                        {
                            if(curKey != partbookNum)
                            {
                                parts[curKey].changePage(currentComposition);
                            }
                        }
                    }
                    divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                };

                function generateDivaOptions(num)
                {
                    return {
                        adaptivePadding: 0,
                        enableAutoHeight: false,
                        enableAutoTitle: false,
                        enableAutoWidth: false,   
                        enableCanvas: false,        
                        enableDownload: false,
                        enableFullscreen: false,
                        enableGridIcon: false,
                        enableLinkIcon: false,
                        fixedHeightGrid: false,
                        iipServerURL: "http://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
                        objectData: "json/partbook" + num + ".json",
                        imageDir: "/srv/images/dow_partbooks/" + num,
                        viewerWidthPadding: 0,
                        viewerHeightPadding: 0,
                        zoomLevel: 2
                    };
                }
                var partbookData = {};
                var parts = {};
                var currentComposition;
                var divaChangeHandle;
                $(document).ready(function() 
                {
                    $.ajax(
                    {
                        url: 'partbooks.json',
                        cache: true,
                        dataType: 'json',
                        success: function (data, status, jqxhr)
                        {
                            partbookData = data;

                            for(curKey in partbookData)
                            {
                                $("body").append("<div id='diva-wrapper" + curKey + "' class='diva-wrapper'></div>");
                                parts[curKey] = (new Part('#diva-wrapper' + curKey, curKey));
                            }

                            var loadedCount = 0;
                            diva.Events.subscribe('ViewerDidLoad', function()
                            {
                                loadedCount += 1;
                                if(loadedCount == $('.diva-wrapper').length)
                                {
                                    $('.diva-tools-right').addClass('diva-tools-right-alt').removeClass('diva-tools-right');
                                    $('.diva-wrapper').draggable({
                                        start: function(e, ui)
                                        {
                                            $('.diva-wrapper').css('z-index', 2);
                                            ui.helper.css('z-index', 3);
                                        }
                                    });
                                }
                            });
                            divaChangeHandle = diva.Events.subscribe('VisiblePageDidChange', divaChangeListener);
                        }
                    });
                    
                });
            </script>
        </head>
        <body>
        </body>
    </html>
